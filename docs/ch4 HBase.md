# Chapter4 分布式数据库HBase

> shenhao

## 4.0 产生的背景

在介绍HBase之前，我们首先来思考一下Hadoop的局限？

### 4.0.1 Hadoop的局限

Hadoop 可以通过 HDFS 来存储**结构化**、**半结构**甚至**非结构化**的数据，它是传统数据库的补充，是海量数据存储的最佳方法，它针对大文件的存储，批量访问和流式访问都做了优化，同时也通过多副本解决了容灾问题。

但是Hadoop的缺陷在于它只能执行**批处理**，并且只能以**顺序的方式访问数据**。这意味着，即使是最简单的工作，也必须搜索整个数据集，**无法实现对数据的随机访问**。反观传统的关系型数据库，其主要特点就在于随机访问，但它们却不能用于海量数据的存储。

在这种情况下，必须有一种新的方案来解决海量数据存储和随机访问的问题，HBase 因此孕育而生！！

> 补充：HBase，Cassandra，couchDB，Dynamo 和 MongoDB 也能存储海量数据并支持随机访问。

### 4.0.2 HBase VS 传统数据库

首先，我们来了解一下数据结构的分类：

- **结构化数据**：即以关系型数据库表形式管理的数据；
- **半结构化数据**：非关系模型的，有基本固定结构模式的数据，例如日志文件、XML 文档、JSON 文档、Email 等；
- **非结构化数据**：没有固定模式的数据，如 WORD、PDF、PPT、EXL，各种格式的图片、视频等。

为了存储不同的数据结构，也诞生了众多类型的数据库：

- **关系型数据库**：关系型数据库模型是把复杂的数据结构归结为简单的二元关系（即二维表格形式）。
  - 代表软件：**MySQL**
- **键值存储数据库**：键值数据库是一种非关系数据库，它使用简单的键值方法来存储数据。键值数据库将数据存储为键值对集合，其中键作为唯一标识符。
  - 代表软件：**Redis**
- **列存储数据库**：列式存储(column-based)是相对于传统关系型数据库的行式存储(Row-basedstorage)来说的。简单来说两者的区别就是对表中数据的存储形式的差异。
  - 代表软件：**HBase**
- **面向文档数据库**：此类数据库可存放并获取文档，可以是XML、JSON、BSON等格式，这些文档具备可述性（self-describing），呈现分层的树状结构（hierarchical tree data structure），可以包含映射表、集合和纯量值。数据库中的文档彼此相似，但不必完全相同。文档数据库所存放的文档，就相当于键值数据库所存放的“值”。文档数据库可视为其值可查的键值数据库。
  - 代表软件：**MongoDB**
- **图形数据库**：图形数据库顾名思义，就是一种存储图形关系的数据库。图形数据库是NoSQL数据库的一种类型，可以用以存储实体之间的关系信息。最常见例子就是社会网络中人与人之间的关系。
  - 代表软件：**Neo4J**、ArangoDB、OrientDB、FlockDB、GraphDB、InfiniteGraph、Titan和Cayley等
- **搜索引擎数据库**：搜索引擎数据库是一类专门用于数据内容搜索的非关系数据库。搜索引擎数据库使用索引对数据中的相似特征进行归类，并提高搜索能力。搜索引擎数据库经过优化，以处理可能很长、半结构化或非结构化的数据，它们通常提供专业的方法，例如全文搜索、复杂搜索表达式和搜索结果排名。 
  - 代表软件：**Solr**、**Elasticsearch**等

**补充了那么多冷知识，那我们来看一下为什么传统数据库不能适应如今大数据的时代呢？**

<img src="../doc_imgs/ch2.0.12.png" alt="ch2.0.12" style="zoom: 67%;" />



随着 Web 2.0 应用的不断发展，传统的关系数据库已经无法满足 Web 2.0 的需求，无论在**数据高并发**方面，还是在**高可拓展性**和**高可用性方面**，传统的关系型数据库都显得力不从心，其完善的事务机制和高效的查询机制也成为“鸡肋”。因此包括 HBase 在内的非关系型数据库的逐渐崭露头角！！

HBase与传统的关系型数据库的区别主要在于：

- **数据类型**：关系型数据库数据类型较为丰富，int，date，long等。Hbase数据类型简单，每个数据都被存储为未经解释的字符串，用户需要自己编写程序把字符串解析成不同的数据类型。
- **数据操作**：关系型数据库存在增删改查，还有我们比较熟悉的联表操作，效率较低。Hbase不会把数据十分的规范化。很多数据是存在一张表里，避免了连接低效率的连接操作。
- **存储模式**：关系型数据库行模式存储，Hbase是基于列存储。
- **数据索引**：关系型数据库可以对不同的列构建复杂的索引结构。Hbase支持对行键的索引。
- **数据维护**：更新操作时，关系型数据库会把数据替换掉，Hbase会保留旧的版本数据一段时间，到了一定期限才会在后台清理数据。
- **可伸缩性**：关系型数据库很难实现水平扩展，Hbase采用分布式集群存储，水平扩展性较好

但是相比于关系型数据库，HBase也有自身的局限，由于其不支持事务，因此无法实现跨行的原子性。

## 4.1 概述

### 4.1.1 HBase 简介

HBase是构建在Hadoop文件系统之上的一个**高可靠、高性能、面向列、可伸缩**的**分布式数据库**，主要用来存储**非结构化**和**半结构化**的松散数据。它是谷歌 BigTable 的开源实现，可以通过水平扩展的方式，利用廉价计算机集群处理由超过10亿行数据和数百万列元素组成的数据表。

HBase旨在提供对大量结构化数据的快速随机访问。它利用Hadoop文件系统(HDFS)提供的容错功能，同时作为Hadoop生态系统的一部分，提供对Hadoop文件系统中的数据的随机实时读写访问。

在Hadoop生态系统中，HBase 利用 Hadoop MapReduce来处理 HBase 中的海量数据，实现高性能计算；利用 ZooKeeper 作为协同服务，实现稳定服务和失败恢复；使用 HDFS 作为高可靠的底层存储，利用廉价集群提供海量数据存储能力。（当然，HBase 也可以直接使用本地文件系统而不用 HDFS 作为底层数据存储方式。）Sqoop 为 HBase 提供了高效、便捷的 RDBMS 数据导入功能，Pig 和 Hive 为 HBase 提供了高层语言支持。

<img src="C:\Users\56550\Desktop\Big Data\doc_imgs\ch4.1.1.png" alt="Hadoop生态系统" style="zoom:50%;" />

### 4.1.2 HBase 访问接口

HBase提供了众多的访问方式，详见下表。


| **类型**            | **特点**                                             | **场合**                                      |
| :------------------ | ---------------------------------------------------- | --------------------------------------------- |
| **Native Java API** | 最常规和高效的访问方式                               | 适合Hadoop MapReduce作业并行批处理HBase表数据 |
| **HBase Shell**     | HBase的命令行工具，最简单的接口                      | 适合HBase管理使用                             |
| **Thrift Gateway**  | 利用Thrift序列化技术，支持C++、PHP、Python等多种语言 | 适合其他异构系统在线访问HBase表数据           |
| **REST Gateway**    | 解除了语言限制                                       | 支持REST风格的Http API访问HBase               |
| **Pig**             | 使用Pig Latin流式编程语言来处理HBase中的数据         | 适合做数据统计                                |
| **Hive**            | 简单                                                 | 当需要以类似SQL语言方式来访问HBase的时候$$44  |

## 4.2 HBase 数据模型

数据模型是一个数据库产品的核心，本节介绍 HBase 列族数据模型，包括表、行键、列族、列限定符、单元格、时间戳等概念，并阐述 HBase 数据库的概念视图和物理视图的差别等。

### 4.2.1 数据模型概述

- HBase是一个稀疏、多维度、排序的映射表，这张表的**索引**是**行键、列族、列限定符和时间戳**。
- 每个值是一个未经解释的字符串，没有数据类型。
- 用户在表中存储数据，每一行都有一个可排序的行键和任意多的列。
- 表在水平方向由一个或者多个列族组成，一个列族中可以包含任意多个列，**同一个列族里面的数据存储在一起**。
- 列族支持动态扩展，可以很轻松地添加一个列族或列，无需预先定义列的数量以及类型，所有列均以字符串形式存储。因此对于整个映射表的每行数据而言，有些列的值是空的，所以说 HBase 是稀疏的。
- HBase中执行**更新**操作时，并不会删除数据旧的版本，而是**生成一个新的版本**，旧有的版本仍然保留（这是和HDFS只允许追加不允许修改的特性相关的）。

### 4.2.2 数据模型的相关概念

1. **表**
    HBase采用表来组织数据，表由行和列组成，列划分为若干个列族

2. **行**
    每个HBase表都由若干行组成，每个行由行键（row key）来标识。

3. **列族**
    一个HBase表被分组成许多“列族”（Column Family）的集合，它是基本的访问控制单元。表中的每个列都归属于某个列族，数据可以被存放到列族的某个列下面（列族需要先创建好）。在创建完列族以后，就可以使用同一个列族当中的列。列名都以列族作为前缀。例如， courses:history 和 courses:math 这两个列都属于 courses这个列族。

4. **列限定符**
    列族里的数据通过列限定符（或列）来定位。

5. **单元格**
    在HBase表中，通过行、列族和列限定符确定一个“单元格”（cell），单元格中存储的数据没有数据类型，总被视为字节数组byte[]。

6. **时间戳**
    每个单元格都保存着同一份数据的多个版本，这些版本采用时间戳进行索引。

下面用一个实例为阐释HBase的数据模型，下图为一张用来存储学生信息的 HBase 表。

<img src="https://gitee.com/shenhao-stu/picgo/raw/master/Others/image-20211127205537883.png" alt="image-20211127205537883" style="zoom:50%;" />

学号作为行键来唯一标识每个学生
